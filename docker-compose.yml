services:

  # ====================================================================================
  # EDGE AI LAYER
  # ====================================================================================

  # ------------------------------------------------------------------------------------
  # MQTT Broker (Eclipse Mosquitto)
  # ------------------------------------------------------------------------------------
  mqtt:
    image: eclipse-mosquitto:2
    container_name: ming-mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -h localhost -t '$$SYS/broker/uptime' -C 1 -W 3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ming-network

  # ------------------------------------------------------------------------------------
  # Time-Series Database (InfluxDB)
  # ------------------------------------------------------------------------------------
  influxdb:
    image: influxdb:2
    container_name: ming-influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_PASSWORD:-adminpassword}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG:-ming}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET:-iot}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUXDB_TOKEN:-ming-stack-token}
      INFLUXDB_SANDBOX_BUCKET: ${INFLUXDB_SANDBOX_BUCKET:-sandbox}
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
      - ./scripts/init-sandbox.sh:/docker-entrypoint-initdb.d/init-sandbox.sh:ro
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - ming-network

  # ------------------------------------------------------------------------------------
  # Workflow Engine (Node-RED)
  # ------------------------------------------------------------------------------------
  node-red:
    image: nodered/node-red:latest
    container_name: ming-node-red
    restart: unless-stopped
    ports:
      - "1880:1880"
    environment:
      TZ: ${TZ:-UTC}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN:-ming-stack-token}
      INFLUXDB_ORG: ${INFLUXDB_ORG:-ming}
    volumes:
      - node-red-data:/data
      - ./config/node-red/settings.js:/data/settings.js:ro
      - ./config/node-red/flows.json:/data/flows.json
    depends_on:
      mqtt:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:1880',r=>{r.statusCode===200?process.exit(0):process.exit(1)}).on('error',()=>process.exit(1))\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - ming-network

  # ------------------------------------------------------------------------------------
  # Data Visualization (Grafana)
  # ------------------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: ming-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-adminpassword}
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      influxdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - ming-network

  # ====================================================================================
  # GEN AI LAYER
  # ====================================================================================

  # ------------------------------------------------------------------------------------
  # Workflow Automation (n8n)
  # ------------------------------------------------------------------------------------
  n8n:
    image: n8nio/n8n:latest
    container_name: ming-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_USER:-admin}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_PASSWORD:-adminpassword}
      N8N_HOST: ${N8N_HOST:-localhost}
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      WEBHOOK_URL: http://${N8N_HOST:-localhost}:5678/
      GENERIC_TIMEZONE: ${TZ:-UTC}
    volumes:
      - n8n-data:/home/node/.n8n
    depends_on:
      mqtt:
        condition: service_healthy
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - ming-network

  # ------------------------------------------------------------------------------------
  # AI Agent Framework (Letta)
  # ------------------------------------------------------------------------------------
  letta:
    image: letta/letta:latest
    container_name: ming-letta
    restart: unless-stopped
    ports:
      - "8283:8283"
    environment:
      LETTA_SERVER_HOST: 0.0.0.0
      LETTA_SERVER_PORT: 8283
      OPENAI_API_BASE: http://ollama:11434/v1
      OPENAI_API_KEY: ollama
    volumes:
      - letta-data:/root/.letta
    depends_on:
      ollama:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8283/v1/health')\" 2>/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ming-network

  # ------------------------------------------------------------------------------------
  # Local LLM Runtime (Ollama)
  # ------------------------------------------------------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: ming-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    environment:
      OLLAMA_HOST: 0.0.0.0
    volumes:
      - ollama-data:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "ollama list > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - ming-network
    # Uncomment for NVIDIA GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # ------------------------------------------------------------------------------------
  # Text-to-Speech (Kokoro)
  # ------------------------------------------------------------------------------------
  kokoro:
    image: ghcr.io/remsky/kokoro-fastapi:latest
    container_name: ming-kokoro
    restart: unless-stopped
    ports:
      - "8880:8880"
    environment:
      KOKORO_HOST: 0.0.0.0
      KOKORO_PORT: 8880
    volumes:
      - kokoro-data:/app/voices
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8880/')\" 2>/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - ming-network

# ====================================================================================
# NETWORKS
# ====================================================================================
networks:
  ming-network:
    name: ming-network
    driver: bridge

# ====================================================================================
# VOLUMES
# ====================================================================================
volumes:
  mosquitto-data:
  mosquitto-log:
  influxdb-data:
  influxdb-config:
  node-red-data:
  grafana-data:
  n8n-data:
  letta-data:
  ollama-data:
  kokoro-data:
